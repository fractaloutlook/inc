<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>One-Shot Valley 1.2</title>
<style>
    body { background: #111; color: white; margin: 0; overflow: hidden; font-family: monospace; user-select: none; }
    #wrap { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
    canvas { background: #567d46; box-shadow: 0 0 30px #000; image-rendering: pixelated; border: 4px solid #3e2723; }
    .ui { position: absolute; width: 800px; height: 600px; pointer-events: none; }
    #hud { display: flex; justify-content: space-between; padding: 10px; font-weight: bold; font-size: 20px; text-shadow: 2px 2px 0 #000; }
    #bar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
    .slot { width: 50px; height: 50px; background: rgba(0,0,0,0.6); border: 2px solid #888; display: flex; justify-content: center; align-items: center; font-size: 28px; cursor: pointer; position: relative; transition: 0.1s; }
    .slot.on { border-color: gold; background: rgba(255,215,0,0.3); transform: scale(1.1); box-shadow: 0 0 10px gold; }
    .ct { position: absolute; bottom: 0; right: 0; font-size: 12px; font-weight: bold; color: #fff; background: #000; padding:1px 3px; border-radius: 4px;}
    #dlg { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); width: 500px; background: white; color: black; border: 4px double #000; padding: 15px; display: none; pointer-events: auto; font-family: serif; font-size: 18px; z-index: 10; }
    #shop { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff8e1; color:#000; padding:20px; border:5px solid #5d4037; display:none; pointer-events:auto; width:300px; text-align:center; box-shadow: 5px 5px 15px #000; z-index: 10;}
    .buy { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #aaa; cursor: pointer; font-weight: bold; }
    .buy:hover { background: #ffe0b2; }
    #overlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; mix-blend-mode:multiply; transition: background 1s; }
    .btn { background: #333; color: white; border: 1px solid white; padding: 5px 10px; cursor: pointer; margin-top: 10px; }
    .btn:hover { background: #555; }
</style>
</head>
<body>
<div id="wrap">
    <canvas id="c" width="800" height="600"></canvas>
    <div id="overlay"></div>
    <div class="ui">
        <div id="hud">
            <span id="date">Day 1</span> 
            <span id="cash">0 G</span> 
            <span id="nrg">100/100</span>
        </div>
        <div id="dlg"><b id="dName"></b><hr><span id="dMsg"></span><br><small style="float:right">[SPACE]</small></div>
        <div id="shop"><h3>General Store</h3><div id="list"></div><button class="btn" onclick="shop(false)">Leave</button></div>
    </div>
    <div id="bar"></div>
</div>
<script>
// --- ASSETS & CONFIG ---
const TILE=40, W=40, H=30, CVS_W=800, CVS_H=600;
const GFX = { 
    p:'üßë‚Äçüåæ', grass:'#76c466', dirt:'#795548', wet:'#3e2723', till:'#8d6e63', stone:'ü™®', wood:'ü™µ', tree:'üå≤', 
    water:'#29b6f6', wall:'#5d4037', floor:'#d7ccc8', house:'üè†', barn:'üõñ', shop:'üè™', bin:'üì¶', npc:'üëµ', merch:'üßî',
    s_turnip:'üå±', p_turnip:'üåø', r_turnip:'ü•î', s_corn:'üåΩ', r_corn:'üåΩ', fish:'üêü', dead:'üçÇ'
};

// --- STATE ---
const G = {
    day:1, hr:6, min:0, tick:0, money:100, stam:100, maxStam:100,
    map:'farm', pause:false,
    cam:{x:0, y:0},
    p:{x:10*TILE, y:10*TILE, spd:5, dir:{x:0,y:1}}, // Added dir for facing logic
    inv:[
        {id:'hoe',s:'‚õèÔ∏è'},{id:'water',s:'üöø'},{id:'axe',s:'ü™ì'},{id:'pick',s:'‚öíÔ∏è'},{id:'rod',s:'üé£'},
        {id:'turnip',s:'üå±',ct:2,type:'seed',v:0}, null, null, null, null
    ],
    slot:0,
    maps:{}, ents:[], floats:[]
};

const cvs = document.getElementById('c'), ctx = cvs.getContext('2d');

function init() {
    // Farm Map
    const fm = mkMap();
    rect(fm,0,0,W,1,'tree',true); rect(fm,0,0,1,H,'tree',true); rect(fm,W-1,0,1,H,'tree',true); // Walls
    rect(fm,32,0,8,H,'water',true); // River
    bld(fm,5,5,3,3,'house'); bld(fm,15,5,4,3,'barn');
    fm[8][8]={t:'grass',obj:'bin',sol:true}; // Bin
    
    // Clear Path to Town (Fixes Stuck at South)
    rect(fm, 15, H-3, 5, 3, 'dirt', false); 

    // Town Map
    const tm = mkMap();
    rect(tm,0,0,W,1,'tree',true); rect(tm,0,0,1,H,'tree',true); rect(tm,W-1,0,1,H,'tree',true); rect(tm,0,H-1,W,1,'tree',true);
    rect(tm,15,0,5,H,'dirt',false); // Road
    bld(tm,5,10,4,4,'shop');
    
    G.maps = { farm:{d:fm, w:W, h:H}, town:{d:tm, w:W, h:H} };
    G.ents = [
        {m:'town', x:8, y:13, spr:'merch', n:'Jeff', txt:['Welcome!','Seeds on sale.']},
        {m:'town', x:25, y:15, spr:'npc', n:'Granny', txt:['My knees hurt.', 'Fishing is relaxing.']}
    ];

    if(localStorage.getItem('osv2_save')) load();
    ui(); loop();
}

function mkMap() {
    let m=[]; 
    for(let y=0;y<H;y++){
        let r=[]; 
        for(let x=0;x<W;x++) {
            let t='grass', o=null, s=false;
            if(Math.random()<0.03){o='stone';s=true;}
            else if(Math.random()<0.03){o='wood';s=true;}
            r.push({t:t, obj:o, sol:s, crop:null});
        }
        m.push(r);
    }
    return m;
}

function rect(m,x,y,w,h,t,s) { 
    for(let i=y;i<y+h;i++) for(let j=x;j<x+w;j++) { 
        if(m[i] && m[i][j]) { m[i][j].t=t; m[i][j].sol=s; m[i][j].obj=null; }
    } 
}
function bld(m,x,y,w,h,id) { rect(m,x,y,w,h,'wall',true); m[y+h-1][x+1].obj=id; m[y+h][x+1]={t:'floor',sol:false}; }

// --- INPUT ---
const keys={}; const mouse={x:0,y:0};
window.onkeydown=e=>{
    keys[e.key.toLowerCase()]=true; 
    if(e.code=='Space') interact();
    if(e.code=='KeyF') sellItem();
    if(e.key>='1' && e.key<='9') {G.slot=e.key-1; ui();}
};
window.onkeyup=e=>keys[e.key.toLowerCase()]=false;
cvs.onmousemove=e=>{const r=cvs.getBoundingClientRect(); mouse.x=e.clientX-r.left; mouse.y=e.clientY-r.top;};
cvs.onmousedown=useTool;

// --- LOGIC ---
function interact() {
    if(document.getElementById('dlg').style.display=='block') { document.getElementById('dlg').style.display='none'; G.pause=false; return; }
    
    // Facing Check
    const fx = (G.p.x + 20) + (G.p.dir.x * TILE);
    const fy = (G.p.y + 20) + (G.p.dir.y * TILE);
    const tx = Math.floor(fx/TILE);
    const ty = Math.floor(fy/TILE);

    // Entity Check (NPCs)
    for(let e of G.ents) {
        if(e.m!=G.map) continue;
        if(Math.hypot((e.x*TILE)-fx, (e.y*TILE)-fy) < 50) {
            if(e.spr=='merch') shop(true);
            else msg(e.n, e.txt[Math.floor(Math.random()*e.txt.length)]);
            return;
        }
    }

    // Tile Check
    const t = getTile(tx, ty);
    if(!t) return;
    
    if(t.obj=='house') sleep();
    if(t.obj=='bin') sellItem();
}

function useTool() {
    if(G.pause) return;
    const mx=mouse.x+G.cam.x, my=mouse.y+G.cam.y;
    const tx=Math.floor(mx/TILE), ty=Math.floor(my/TILE);
    
    if(Math.hypot((tx*TILE)-G.p.x, (ty*TILE)-G.p.y) > 120) return; // Range

    const t = getTile(tx, ty);
    if(!t) return;
    
    const it = G.inv[G.slot];
    if(!it || G.stam<=0) return;

    let did=false;
    // Tools
    if(it.id=='hoe' && t.t=='grass' && !t.obj) { t.t='till'; did=true; }
    if(it.id=='water' && (t.t=='till'||t.crop)) { t.t='wet'; if(t.crop) t.crop.w=true; did=true; }
    if(it.id=='axe' && (t.obj=='wood'||t.obj=='tree')) { t.obj=null; t.sol=false; pop('+Wood',mx,my); did=true; }
    if(it.id=='pick' && t.obj=='stone') { t.obj=null; t.sol=false; pop('+Stone',mx,my); did=true; }
    if(it.id=='rod' && t.t=='water') { 
        if(Math.random()<0.3) { addItem({id:'fish',s:'üêü',v:50,ct:1,type:'fish'}); pop('Fish!',mx,my,'cyan'); } 
        else pop('...',mx,my);
        did=true; 
    }
    
    // Harvest
    if(t.crop && t.crop.s==3) { 
        // Can harvest with hands or sickle
        let val = t.crop.id=='corn'?80:60;
        let cropId = t.crop.id=='corn'?'r_corn':'r_turnip';
        addItem({id:cropId, s:GFX[cropId], v:val, ct:1, type:'crop'});
        t.crop=null; t.obj=null; pop('Harvest!',mx,my,'gold'); did=true;
    }

    // Seeds
    if(it.type=='seed' && t.t=='till' && !t.crop) {
        let isCorn = it.id=='corn';
        t.crop={id:isCorn?'corn':'turnip', s:1, w:(t.t=='wet')}; 
        it.ct--; if(it.ct<=0) G.inv[G.slot]=null; 
        did=true;
    }

    if(did) { G.stam-=2; ui(); }
}

function sleep() {
    G.day++; G.hr=6; G.min=0; G.stam=G.maxStam;
    const m = G.maps.farm.d;
    for(let row of m) for(let t of row) {
        if(t.t=='wet') t.t='till';
        if(t.crop && t.crop.w) { t.crop.w=false; if(t.crop.s<3) t.crop.s++; }
    }
    save(); pop("Day " + G.day, G.p.x, G.p.y); ui();
}

function loop() {
    if(!G.pause) {
        G.tick++;
        if(G.tick>40) { 
            G.tick=0; G.min+=10; 
            if(G.min==60){G.min=0; G.hr++; if(G.hr==24)G.hr=0;}
            let o=0; if(G.hr>=20||G.hr<5)o=0.6; else if(G.hr>=18)o=0.3;
            document.getElementById('overlay').style.backgroundColor=`rgba(0,0,50,${o})`;
            ui();
        }

        let vx=0, vy=0;
        if(keys['w']){vy=-G.p.spd; G.p.dir={x:0,y:-1};}
        if(keys['s']){vy=G.p.spd; G.p.dir={x:0,y:1};}
        if(keys['a']){vx=-G.p.spd; G.p.dir={x:-1,y:0};}
        if(keys['d']){vx=G.p.spd; G.p.dir={x:1,y:0};}
        
        // Map Transition Logic
        let nextMap = null;
        if(G.map=='farm' && G.p.y > (H*TILE)-40) { nextMap='town'; G.p.y=20; }
        else if(G.map=='town' && G.p.y < 10) { nextMap='farm'; G.p.y=(H*TILE)-60; }
        
        if (nextMap) {
            G.map = nextMap;
            // Clear entities from path to prevent getting stuck on load
            G.ents.forEach(e => { if(e.m=='global'){e.x=G.p.x/TILE; e.y=G.p.y/TILE;} });
        } else {
            if(!col(G.p.x+vx, G.p.y)) G.p.x+=vx;
            if(!col(G.p.x, G.p.y+vy)) G.p.y+=vy;
        }

        G.cam.x = Math.max(0, Math.min(G.p.x - CVS_W/2, W*TILE - CVS_W));
        G.cam.y = Math.max(0, Math.min(G.p.y - CVS_H/2, H*TILE - CVS_H));
        
        for(let i=G.floats.length-1; i>=0; i--) {
            let f = G.floats[i]; f.y-=1; f.l--; if(f.l<=0) G.floats.splice(i,1);
        }
    }
    draw(); requestAnimationFrame(loop);
}

function col(x,y) {
    let tx = Math.floor((x+20)/TILE), ty = Math.floor((y+30)/TILE);
    if(tx < 0 || tx >= W || ty < 0 || ty >= H) return true;
    return G.maps[G.map].d[ty][tx].sol;
}

function getTile(tx, ty) {
    if(tx < 0 || tx >= W || ty < 0 || ty >= H) return null;
    return G.maps[G.map].d[ty][tx];
}

// --- UI & DATA ---
function ui() {
    document.getElementById('date').innerText = `Day ${G.day} ${G.hr.toString().padStart(2,'0')}:${G.min.toString().padStart(2,'0')}`;
    document.getElementById('cash').innerText = G.money + ' G';
    document.getElementById('nrg').innerText = G.stam + '/' + G.maxStam;
    const b = document.getElementById('bar'); b.innerHTML='';
    G.inv.forEach((i,idx)=>{
        let d=document.createElement('div'); d.className='slot '+(idx==G.slot?'on':'');
        if(i){ d.innerHTML=i.s; if(i.ct) d.innerHTML+=`<span class="ct">${i.ct}</span>`; }
        d.onclick=()=>{G.slot=idx; ui();}; b.appendChild(d);
    });
}
function msg(n,t) { G.pause=true; document.getElementById('dlg').style.display='block'; document.getElementById('dName').innerText=n; document.getElementById('dMsg').innerText=t; }
function pop(t,x,y,c='white') { G.floats.push({t,x,y,l:60,c}); }

function addItem(newItem) {
    let ex = G.inv.find(i=>i&&i.id==newItem.id);
    if(ex) { ex.ct += newItem.ct; }
    else {
        let empty = G.inv.findIndex(i=>!i);
        if(empty>=0) G.inv[empty] = newItem;
        else pop("Full!", G.p.x, G.p.y, 'red');
    }
    ui();
}

function sellItem() {
    let i = G.inv[G.slot];
    if(i && i.v > 0) {
        let gain = i.v * (i.ct || 1);
        G.money += gain;
        pop(`+${gain}G`, G.p.x, G.p.y, 'gold');
        G.inv[G.slot] = null;
        ui();
    } else {
        pop("Can't sell!", G.p.x, G.p.y, 'red');
    }
}

function shop(open) {
    const s=document.getElementById('shop');
    if(!open) { s.style.display='none'; G.pause=false; return; }
    G.pause=true; s.style.display='block';
    const l=document.getElementById('list'); l.innerHTML='';
    [{n:'Turnip',p:20,id:'turnip'},{n:'Corn',p:50,id:'corn'}].forEach(seed=>{
        let d=document.createElement('div'); d.className='buy';
        d.innerHTML=`<span>${seed.n}</span><span>${seed.p}G</span>`;
        d.onclick=()=>{
            if(G.money>=seed.p){
                G.money-=seed.p; 
                addItem({id:seed.id, s:'üå±', ct:5, type:'seed', v:0});
            }
        };
        l.appendChild(d);
    });
}

function save() { localStorage.setItem('osv2_save', JSON.stringify({d:G.day, m:G.money, i:G.inv})); }
function load() { const d=JSON.parse(localStorage.getItem('osv2_save')); if(d){G.day=d.d; G.money=d.m; G.inv=d.i;} }

// --- RENDER ---
function draw() {
    ctx.clearRect(0,0,CVS_W,CVS_H);
    const m = G.maps[G.map].d;
    const sx=Math.floor(G.cam.x/TILE), sy=Math.floor(G.cam.y/TILE);
    
    for(let y=sy; y<sy+17; y++) for(let x=sx; x<sx+22; x++) {
        if(y<0||y>=H||x<0||x>=W) continue;
        const t = m[y][x];
        const dx = x*TILE-G.cam.x, dy = y*TILE-G.cam.y;
        
        ctx.fillStyle = GFX[t.t]||'#000'; ctx.fillRect(dx,dy,TILE,TILE);
        ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.strokeRect(dx,dy,TILE,TILE);
        
        if(t.obj) {
            ctx.font = '28px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(GFX[t.obj]||'?', dx+20, dy+20);
        }
        if(t.crop) {
            ctx.font = '28px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
            let s = GFX.s_turnip;
            if(t.crop.id=='corn') s=GFX.s_corn;
            if(t.crop.s==2) s=GFX.p_turnip;
            if(t.crop.s==3) s = t.crop.id=='corn' ? GFX.r_corn : GFX.r_turnip;
            ctx.fillText(s, dx+20, dy+20);
        }
    }

    for(let e of G.ents) if(e.m==G.map) ctx.fillText(GFX[e.spr], e.x*TILE-G.cam.x+20, e.y*TILE-G.cam.y+20);
    ctx.fillText(GFX.p, G.p.x-G.cam.x+20, G.p.y-G.cam.y+20);

    const mx=mouse.x+G.cam.x, my=mouse.y+G.cam.y;
    const tx=Math.floor(mx/TILE), ty=Math.floor(my/TILE);
    ctx.strokeStyle='white'; ctx.lineWidth=2; ctx.strokeRect(tx*TILE-G.cam.x, ty*TILE-G.cam.y, TILE, TILE);

    ctx.font='bold 20px monospace';
    for(let f of G.floats) { ctx.fillStyle=f.c; ctx.fillText(f.t, f.x-G.cam.x, f.y-G.cam.y); }
}

init();
</script>
</body>
</html>