<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>One-Shot Valley</title>
<style>
    body { background-color: #202020; color: white; margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
    #game-container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
    canvas { background: #567d46; box-shadow: 0 0 20px rgba(0,0,0,0.5); image-rendering: pixelated; }
    
    /* UI Overlays */
    .ui-layer { position: absolute; pointer-events: none; width: 800px; height: 600px; }
    #hud { display: flex; justify-content: space-between; padding: 10px; font-weight: bold; text-shadow: 1px 1px 0 #000; font-size: 18px; }
    #toolbar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 10px; pointer-events: auto; }
    .slot { width: 40px; height: 40px; border: 2px solid #555; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; background: rgba(0,0,0,0.3); position: relative; transition: 0.1s; }
    .slot.active { border-color: gold; transform: scale(1.1); background: rgba(255,215,0,0.2); }
    .slot span.qty { position: absolute; bottom: 0; right: 2px; font-size: 10px; color: white; }
    
    #dialogue-box { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); width: 600px; background: white; color: black; border: 4px solid #4a3c31; padding: 15px; border-radius: 4px; display: none; pointer-events: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    #dialogue-name { font-weight: bold; margin-bottom: 5px; color: #d32f2f; }
    
    #shop-menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff8e1; color: black; padding: 20px; border: 4px double #5d4037; display: none; pointer-events: auto; width: 400px; }
    .shop-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #ccc; cursor: pointer; }
    .shop-item:hover { background: #ffe0b2; }

    #notification { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); color: yellow; text-shadow: 2px 2px 0 #000; font-size: 24px; opacity: 0; transition: opacity 0.5s; font-weight: bold; }
    
    .overlay { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; mix-blend-mode: multiply; background: rgba(0,0,255,0); transition: background 2s; }
</style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div class="overlay" id="day-night-overlay"></div>
    
    <div class="ui-layer">
        <div id="hud">
            <div id="date-display">Day 1 | Mon | 06:00 AM</div>
            <div id="money-display">0 G</div>
            <div id="stamina-display">‚ö° 100/100</div>
        </div>
        
        <div id="notification"></div>

        <div id="dialogue-box">
            <div id="dialogue-name">Mayor</div>
            <div id="dialogue-text">Welcome to the farm!</div>
            <div style="text-align:right; font-size:12px; margin-top:5px;">[SPACE] to continue</div>
        </div>

        <div id="shop-menu">
            <h2 style="text-align:center; margin-top:0;">General Store</h2>
            <div id="shop-list"></div>
            <button onclick="closeShop()" style="margin-top:10px; width:100%;">Leave</button>
        </div>
    </div>

    <div id="toolbar"></div>
</div>

<script>
/** 
 *  ONE-SHOT VALLEY
 *  A complete farming sim skeleton in a single file.
 */

// --- CONFIGURATION ---
const TILE_SIZE = 40;
const MAP_W = 40;
const MAP_H = 30;
const CANVAS_W = 800;
const CANVAS_H = 600;

// Sprites (Emoji mapping)
const GFX = {
    player: 'üßë‚Äçüåæ',
    grass: '#76c466',
    soil: '#6d4c41',
    wet_soil: '#3e2723',
    tilled: '#8d6e63',
    water: '#4fc3f7',
    wood_wall: '#5d4037',
    floor: '#d7ccc8',
    tree: 'üå≤',
    stump: 'ü™µ',
    rock: 'ü™®',
    flower: 'üåª',
    house: 'üè†',
    barn: 'üõñ',
    shop: 'üè™',
    shipping_bin: 'üì¶',
    bed: 'üõèÔ∏è',
    npc_mayor: 'üë¥',
    npc_shop: 'üë©‚Äçüç≥',
    fish: 'üêü',
    bug: 'ü¶ã',
    weed: 'üåø',
    crop_seed: 'üå±',
    crop_1: 'üåø',
    crop_2: 'ü•ï', // Turnip ready
    crop_3: 'üåΩ', // Corn ready
    crop_dead: 'üçÇ'
};

// --- STATE MANAGEMENT ---
const Game = {
    day: 1,
    hour: 6,
    minute: 0,
    totalPlayTime: 0, // for tick updates
    money: 500,
    stamina: 100,
    maxStamina: 100,
    paused: false,
    dialogueActive: false,
    currentMap: 'farm', // 'farm', 'town'
    
    camera: { x: 0, y: 0 },
    
    player: {
        x: 10 * TILE_SIZE,
        y: 10 * TILE_SIZE,
        speed: 4,
        facing: 'down',
        animOffset: 0
    },

    inventory: [
        { id: 'hoe', name: 'Hoe', type: 'tool', icon: '‚õèÔ∏è' },
        { id: 'water', name: 'Water Can', type: 'tool', icon: 'üöø' },
        { id: 'axe', name: 'Axe', type: 'tool', icon: 'ü™ì' },
        { id: 'pick', name: 'Pickaxe', type: 'tool', icon: '‚öíÔ∏è' },
        { id: 'scythe', name: 'Scythe', type: 'tool', icon: 'üó°Ô∏è' },
        { id: 'seeds_turnip', name: 'Turnip Seeds', type: 'item', count: 5, icon: 'Ë¢ã' },
        null, null, null, null 
    ],
    selectedSlot: 0,

    maps: {}, // Will hold grid data
    entities: [], // NPCs, moving objects
    particles: []
};

// --- MAP GENERATION ---
class Tile {
    constructor(type, solid = false) {
        this.type = type;
        this.solid = solid;
        this.crop = null; // { type, days, watered, stage }
        this.obj = null; // 'rock', 'tree', etc
    }
}

function generateMaps() {
    // 1. FARM MAP
    const farm = [];
    for(let y=0; y<MAP_H; y++) {
        const row = [];
        for(let x=0; x<MAP_W; x++) {
            let t = new Tile('grass');
            // Borders
            if(x===0 || x===MAP_W-1 || y===0 || y===MAP_H-1) {
                t.type = 'tree'; t.solid = true; t.obj = 'tree';
            }
            // River
            if(x > 32) { t.type = 'water'; t.solid = true; }
            
            // Random Debris
            if(!t.solid && Math.random() < 0.05) { t.obj = 'rock'; t.solid = true; }
            if(!t.solid && Math.random() < 0.05) { t.obj = 'tree'; t.solid = true; }
            if(!t.solid && Math.random() < 0.05) { t.obj = 'weed'; t.solid = false; }
            
            row.push(t);
        }
        farm.push(row);
    }
    
    // Buildings
    placeBuilding(farm, 5, 5, 3, 3, 'house');
    placeBuilding(farm, 15, 5, 4, 3, 'barn');
    farm[8][8].obj = 'shipping_bin'; farm[8][8].solid = true;
    
    // Exit to town
    for(let i=15; i<20; i++) { farm[MAP_H-1][i].solid = false; farm[MAP_H-1][i].obj = null; farm[MAP_H-1][i].type = 'tilled'; }

    // 2. TOWN MAP
    const town = [];
    for(let y=0; y<MAP_H; y++) {
        const row = [];
        for(let x=0; x<MAP_W; x++) {
            let t = new Tile('grass');
            // Pavement
            if (y > 10 && y < 16) t.type = 'tilled'; // Road
            if(x===0 || x===MAP_W-1 || y===0 || y===MAP_H-1) { t.type = 'tree'; t.solid = true; t.obj = 'tree'; }
            row.push(t);
        }
        town.push(row);
    }
    // Shop
    placeBuilding(town, 10, 4, 4, 4, 'shop');
    
    Game.maps = {
        'farm': { tiles: farm, w: MAP_W, h: MAP_H, neighbors: { 'bottom': 'town' } },
        'town': { tiles: town, w: MAP_W, h: MAP_H, neighbors: { 'top': 'farm' } }
    };
}

function placeBuilding(mapGrid, x, y, w, h, type) {
    for(let i=0; i<h; i++) {
        for(let j=0; j<w; j++) {
            mapGrid[y+i][x+j].type = 'wood_wall';
            mapGrid[y+i][x+j].solid = true;
            mapGrid[y+i][x+j].obj = null;
        }
    }
    // Door
    mapGrid[y+h-1][x+Math.floor(w/2)].type = type; // Marker
    mapGrid[y+h][x+Math.floor(w/2)].type = 'floor'; // Doorstep
    mapGrid[y+h][x+Math.floor(w/2)].solid = false;
}

// --- ENTITIES & NPC ---
class Entity {
    constructor(map, x, y, sprite, name) {
        this.map = map;
        this.x = x * TILE_SIZE;
        this.y = y * TILE_SIZE;
        this.sprite = sprite;
        this.name = name;
        this.w = TILE_SIZE; this.h = TILE_SIZE;
        this.dialogue = ["Hello there!", "Nice weather."];
    }
    update() {
        // Simple random movement
        if(Math.random() < 0.02) {
            const dir = Math.floor(Math.random()*4);
            const speed = 2;
            if(dir===0) this.y -= TILE_SIZE;
            if(dir===1) this.y += TILE_SIZE;
            if(dir===2) this.x -= TILE_SIZE;
            if(dir===3) this.x += TILE_SIZE;
        }
    }
}

function initEntities() {
    Game.entities.push(new Entity('town', 12, 9, GFX.npc_shop, 'Shopkeep'));
    Game.entities.push(new Entity('town', 20, 16, GFX.npc_mayor, 'Mayor'));
}

// --- INPUT HANDLING ---
const keys = {};
const mouse = { x: 0, y: 0, left: false };
window.addEventListener('keydown', e => { 
    keys[e.key.toLowerCase()] = true; 
    if(e.code === 'Space') interact();
    if(parseInt(e.key) >= 1 && parseInt(e.key) <= 0) Game.selectedSlot = parseInt(e.key)-1; 
});
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
const cvs = document.getElementById('gameCanvas');
cvs.addEventListener('mousemove', e => {
    const rect = cvs.getBoundingClientRect();
    mouse.x = e.clientX - rect.left;
    mouse.y = e.clientY - rect.top;
});
cvs.addEventListener('mousedown', () => useTool());
window.addEventListener('wheel', e => {
    if(e.deltaY > 0) Game.selectedSlot = (Game.selectedSlot + 1) % 10;
    else Game.selectedSlot = (Game.selectedSlot - 1 + 10) % 10;
    renderToolbar();
});

// --- CORE SYSTEMS ---

function checkCollision(x, y) {
    const map = Game.maps[Game.currentMap];
    // Map boundaries / Transfer
    if (x < 0 || x >= map.w * TILE_SIZE || y < 0 || y >= map.h * TILE_SIZE) {
        return handleMapTransition(x, y);
    }
    
    // Tile collision
    const tx = Math.floor((x + 10) / TILE_SIZE); // simple hitbox adjustment
    const ty = Math.floor((y + 20) / TILE_SIZE);
    
    // Check bounds again for array access
    if (ty < 0 || ty >= map.h || tx < 0 || tx >= map.w) return true;
    
    return map.tiles[ty][tx].solid;
}

function handleMapTransition(x, y) {
    const map = Game.maps[Game.currentMap];
    if (y >= map.h * TILE_SIZE && map.neighbors.bottom) {
        Game.currentMap = map.neighbors.bottom;
        Game.player.y = 10; // Top of next map
        Game.entities = Game.entities.filter(e => e.map === Game.currentMap || e.map === 'global'); 
        return false;
    }
    if (y < 0 && map.neighbors.top) {
        Game.currentMap = map.neighbors.top;
        Game.player.y = (Game.maps[Game.currentMap].h * TILE_SIZE) - 50;
        return false;
    }
    return true; // Hit a wall with no exit
}

function interact() {
    if(Game.dialogueActive) {
        document.getElementById('dialogue-box').style.display = 'none';
        Game.dialogueActive = false;
        return;
    }

    // Check entity proximity
    const pCx = Game.player.x + TILE_SIZE/2;
    const pCy = Game.player.y + TILE_SIZE/2;
    
    for(let e of Game.entities) {
        if(e.map !== Game.currentMap) continue;
        const dist = Math.hypot(e.x - Game.player.x, e.y - Game.player.y);
        if(dist < 60) {
            if(e.name === 'Shopkeep') openShop();
            else showDialogue(e.name, e.dialogue[Math.floor(Math.random() * e.dialogue.length)]);
            return;
        }
    }

    // Check Tile Proximity (Bed, Shipping Bin)
    const tx = Math.floor(pCx / TILE_SIZE);
    const ty = Math.floor(pCy / TILE_SIZE);
    const tile = Game.maps[Game.currentMap].tiles[ty][tx];

    if(tile.type === 'house') sleep();
    if(tile.obj === 'shipping_bin') showNotification("Items shipped!");
}

function useTool() {
    if(Game.dialogueActive || Game.paused) return;
    
    const worldX = mouse.x + Game.camera.x;
    const worldY = mouse.y + Game.camera.y;
    const tx = Math.floor(worldX / TILE_SIZE);
    const ty = Math.floor(worldY / TILE_SIZE);
    
    // Range check
    const pTx = Math.floor((Game.player.x + TILE_SIZE/2)/TILE_SIZE);
    const pTy = Math.floor((Game.player.y + TILE_SIZE/2)/TILE_SIZE);
    if(Math.abs(tx - pTx) > 1 || Math.abs(ty - pTy) > 1) return;

    const map = Game.maps[Game.currentMap];
    if(ty < 0 || ty >= map.h || tx < 0 || tx >= map.w) return;
    const tile = map.tiles[ty][tx];
    
    const item = Game.inventory[Game.selectedSlot];
    if(!item) return;

    if(Game.stamina <= 0) { showNotification("Too tired!"); return; }

    let didAction = false;

    // --- TOOL LOGIC ---
    if(item.id === 'hoe') {
        if(tile.type === 'grass' && !tile.obj) {
            tile.type = 'tilled';
            didAction = true;
        }
    }
    else if(item.id === 'water') {
        if(tile.type === 'tilled' || (tile.crop)) {
            tile.type = 'wet_soil';
            if(tile.crop) tile.crop.watered = true;
            didAction = true;
        }
    }
    else if(item.id === 'axe') {
        if(tile.obj === 'tree' || tile.obj === 'stump') {
            tile.obj = null; tile.solid = false;
            spawnParticle(tx, ty, '+ Wood');
            didAction = true;
        }
    }
    else if(item.id === 'pick') {
        if(tile.obj === 'rock') {
            tile.obj = null; tile.solid = false;
            spawnParticle(tx, ty, '+ Stone');
            didAction = true;
        }
    }
    else if(item.id === 'scythe') {
        if(tile.obj === 'weed' || (tile.crop && tile.crop.stage === 3)) {
             // Harvest
             if(tile.crop && tile.crop.stage === 3) {
                 Game.money += 50; // Auto sell for simplicity in one-shot
                 spawnParticle(tx, ty, '$$ 50G');
             }
             tile.obj = null; tile.crop = null; tile.solid = false;
             didAction = true;
        }
    }
    else if(item.type === 'item' && item.id.includes('seeds')) {
        if(tile.type === 'tilled' || tile.type === 'wet_soil') {
            if(!tile.crop && item.count > 0) {
                tile.crop = { type: 'turnip', stage: 1, watered: (tile.type==='wet_soil') };
                item.count--;
                if(item.count <= 0) Game.inventory[Game.selectedSlot] = null;
                didAction = true;
                renderToolbar();
            }
        }
    }

    if(didAction) {
        Game.stamina -= 2;
        updateHUD();
    }
}

function sleep() {
    // Transition to next day
    Game.day++;
    Game.hour = 6;
    Game.stamina = Game.maxStamina;
    
    // Process Crops
    const map = Game.maps['farm'];
    for(let row of map.tiles) {
        for(let t of row) {
            if(t.type === 'wet_soil') t.type = 'tilled'; // Dry out
            if(t.crop && t.crop.watered) {
                t.crop.watered = false;
                if(t.crop.stage < 3) t.crop.stage++;
            }
        }
    }
    
    showNotification(`Day ${Game.day} Started! Saved.`);
    saveGame();
    updateHUD();
}

function saveGame() {
    // Simple LocalStorage save
    localStorage.setItem('harvestOneShot_money', Game.money);
    localStorage.setItem('harvestOneShot_day', Game.day);
}

// --- SHOPS & DIALOGUE ---
function showDialogue(name, text) {
    Game.dialogueActive = true;
    document.getElementById('dialogue-box').style.display = 'block';
    document.getElementById('dialogue-name').innerText = name;
    document.getElementById('dialogue-text').innerText = text;
}

function openShop() {
    Game.paused = true;
    const menu = document.getElementById('shop-menu');
    const list = document.getElementById('shop-list');
    list.innerHTML = '';
    
    const wares = [
        { name: 'Turnip Seeds', price: 50, id: 'seeds_turnip', type: 'item' },
        { name: 'Potato Seeds', price: 80, id: 'seeds_potato', type: 'item' },
        { name: 'Stamina Booster', price: 500, id: 'power_berry', type: 'consume' }
    ];
    
    wares.forEach(w => {
        const div = document.createElement('div');
        div.className = 'shop-item';
        div.innerHTML = `<span>${w.name}</span><span>${w.price}G</span>`;
        div.onclick = () => buyItem(w);
        list.appendChild(div);
    });
    
    menu.style.display = 'block';
}

function buyItem(item) {
    if(Game.money >= item.price) {
        Game.money -= item.price;
        if(item.type === 'item') {
            // Find empty slot or stack
            let added = false;
            for(let slot of Game.inventory) {
                if(slot && slot.id === item.id) { slot.count+=5; added=true; break; }
            }
            if(!added) {
                for(let i=0; i<Game.inventory.length; i++) {
                    if(!Game.inventory[i]) {
                        Game.inventory[i] = { id: item.id, name: item.name, type: 'item', count: 5, icon: 'Ë¢ã' };
                        break;
                    }
                }
            }
        } else if (item.id === 'power_berry') {
            Game.maxStamina += 20;
            Game.stamina = Game.maxStamina;
        }
        updateHUD();
        renderToolbar();
    } else {
        alert("Not enough gold!");
    }
}

function closeShop() {
    document.getElementById('shop-menu').style.display = 'none';
    Game.paused = false;
}

function spawnParticle(tx, ty, text) {
    Game.particles.push({ 
        x: tx*TILE_SIZE + TILE_SIZE/2, 
        y: ty*TILE_SIZE, 
        text: text, 
        life: 60 
    });
}

function showNotification(text) {
    const el = document.getElementById('notification');
    el.innerText = text;
    el.style.opacity = 1;
    setTimeout(() => el.style.opacity = 0, 2000);
}

// --- RENDER & LOOP ---
const ctx = cvs.getContext('2d');

function renderToolbar() {
    const toolbar = document.getElementById('toolbar');
    toolbar.innerHTML = '';
    Game.inventory.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = `slot ${i === Game.selectedSlot ? 'active' : ''}`;
        div.onclick = () => { Game.selectedSlot = i; renderToolbar(); };
        if(item) {
            div.innerText = item.icon;