<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>One-Shot Valley: Complete Edition</title>
<style>
    body { background: #111; color: white; margin: 0; overflow: hidden; font-family: monospace; user-select: none; }
    #wrap { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
    canvas { background: #567d46; box-shadow: 0 0 30px #000; image-rendering: pixelated; border: 4px solid #3e2723; }
    .ui { position: absolute; width: 800px; height: 600px; pointer-events: none; }
    #hud { display: flex; justify-content: space-between; padding: 10px; font-weight: bold; font-size: 20px; text-shadow: 2px 2px 0 #000; }
    #bar { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
    .slot { width: 44px; height: 44px; background: rgba(0,0,0,0.6); border: 2px solid #888; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; position: relative; }
    .slot.on { border-color: gold; background: rgba(255,215,0,0.3); transform: scale(1.1); }
    .ct { position: absolute; bottom: 0; right: 0; font-size: 10px; font-weight: bold; }
    #dlg { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); width: 500px; background: white; color: black; border: 4px double #000; padding: 15px; display: none; pointer-events: auto; font-family: serif; }
    #shop { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff8e1; color:#000; padding:20px; border:5px solid #5d4037; display:none; pointer-events:auto; width:300px; text-align:center; box-shadow: 5px 5px 15px #000;}
    .buy { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #aaa; cursor: pointer; }
    .buy:hover { background: #ffe0b2; }
    #overlay { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; mix-blend-mode:multiply; transition: background 1s; }
</style>
</head>
<body>
<div id="wrap">
    <canvas id="c" width="800" height="600"></canvas>
    <div id="overlay"></div>
    <div class="ui">
        <div id="hud"><span id="date">Day 1 06:00</span> <span id="cash">0 G</span> <span id="nrg">100/100</span></div>
        <div id="dlg"><b id="dName"></b><hr><span id="dMsg"></span><br><small style="float:right">[SPACE]</small></div>
        <div id="shop"><h3>General Store</h3><div id="list"></div><br><button onclick="shop(false)">Leave</button></div>
    </div>
    <div id="bar"></div>
</div>
<script>
// --- ASSETS & CONFIG ---
const TILE=40, W=40, H=30, CVS_W=800, CVS_H=600;
const GFX = { 
    p:'ğŸ§‘â€ğŸŒ¾', grass:'#76c466', dirt:'#795548', wet:'#3e2723', till:'#8d6e63', stone:'ğŸª¨', wood:'ğŸªµ', tree:'ğŸŒ²', 
    water:'#29b6f6', wall:'#5d4037', floor:'#d7ccc8', house:'ğŸ ', barn:'ğŸ›–', shop:'ğŸª', bin:'ğŸ“¦', npc:'ğŸ‘µ', merch:'ğŸ§”',
    s_turnip:'ğŸŒ±', p_turnip:'ğŸŒ¿', r_turnip:'ğŸ¥”', dead:'ğŸ‚'
};

// --- STATE ---
const G = {
    day:1, hr:6, min:0, tick:0, money:200, stam:100, maxStam:100,
    map:'farm', pause:false,
    cam:{x:0, y:0},
    p:{x:10*TILE, y:10*TILE, spd:6},
    inv:[{id:'hoe',s:'â›ï¸'},{id:'water',s:'ğŸš¿'},{id:'axe',s:'ğŸª“'},{id:'pick',s:'âš’ï¸'},{id:'scythe',s:'ğŸ—¡ï¸'},{id:'turnip',s:'ğŸŒ±',ct:2,type:'seed',val:20}],
    slot:0,
    maps:{}, ents:[], floats:[]
};

// --- INITIALIZATION ---
const cvs = document.getElementById('c'), ctx = cvs.getContext('2d');

function init() {
    // 1. Generate Farm
    const fm = mkMap();
    rect(fm,0,0,W,1,'tree',true); rect(fm,0,0,1,H,'tree',true); rect(fm,W-1,0,1,H,'tree',true); // Walls
    rect(fm,35,0,5,H,'water',true); // River
    bld(fm,5,5,3,3,'house'); bld(fm,15,5,4,3,'barn');
    fm[8][8]={t:'grass',obj:'bin',sol:true}; // Shipping Bin
    for(let x=15;x<20;x++) fm[H-1][x]={t:'dirt',sol:false}; // Exit
    
    // 2. Generate Town
    const tm = mkMap();
    rect(tm,0,0,W,1,'tree',true); rect(tm,0,0,1,H,'tree',true); rect(tm,W-1,0,1,H,'tree',true); rect(tm,0,H-1,W,1,'tree',true);
    rect(tm,15,0,5,H,'dirt',false); // Road
    bld(tm,5,10,4,4,'shop');
    
    G.maps = { farm:{d:fm, w:W, h:H}, town:{d:tm, w:W, h:H} };
    G.ents = [
        {m:'town', x:8, y:13, spr:'merch', n:'Jeff', txt:['Welcome!','Seeds on sale.']},
        {m:'town', x:17, y:15, spr:'npc', n:'Granny', txt:['Nice day!','My back hurts.']}
    ];

    if(localStorage.getItem('osv_save')) load();
    ui(); loop();
}

function mkMap() {
    let m=[]; 
    for(let y=0;y<H;y++){
        let r=[]; 
        for(let x=0;x<W;x++) {
            let t='grass', o=null, s=false;
            if(Math.random()<0.02){o='stone';s=true;}
            else if(Math.random()<0.02){o='wood';s=true;}
            r.push({t:t, obj:o, sol:s, crop:null});
        }
        m.push(r);
    }
    return m;
}

function rect(m,x,y,w,h,t,s) { for(let i=y;i<y+h;i++) for(let j=x;j<x+w;j++) { m[i][j].t=t; m[i][j].sol=s; m[i][j].obj=null; } }
function bld(m,x,y,w,h,id) { rect(m,x,y,w,h,'wall',true); m[y+h-1][x+1].obj=id; m[y+h][x+1]={t:'floor',sol:false}; }

// --- INPUT ---
const keys={}; const mouse={x:0,y:0};
window.onkeydown=e=>{
    keys[e.key.toLowerCase()]=true; 
    if(e.code=='Space') act();
    if(e.key>='1' && e.key<='6') {G.slot=e.key-1; ui();}
};
window.onkeyup=e=>keys[e.key.toLowerCase()]=false;
cvs.onmousemove=e=>{const r=cvs.getBoundingClientRect(); mouse.x=e.clientX-r.left; mouse.y=e.clientY-r.top;};
cvs.onmousedown=useTool;

// --- LOGIC ---
function act() {
    if(document.getElementById('dlg').style.display=='block') { document.getElementById('dlg').style.display='none'; G.pause=false; return; }
    
    // Check NPC/Shop
    for(let e of G.ents) {
        if(e.m!=G.map) continue;
        if(Math.hypot((e.x*TILE)-G.p.x, (e.y*TILE)-G.p.y) < 60) {
            if(e.spr=='merch') shop(true);
            else msg(e.n, e.txt[Math.floor(Math.random()*e.txt.length)]);
            return;
        }
    }
    // Check Tiles
    const tx=Math.floor((G.p.x+20)/TILE), ty=Math.floor((G.p.y+20)/TILE);
    const t=G.maps[G.map].d[ty][tx];
    if(t.obj=='house') sleep();
    if(t.obj=='bin') { pop('Shipped!',G.p.x,G.p.y); }
}

function useTool() {
    if(G.pause) return;
    const mx=mouse.x+G.cam.x, my=mouse.y+G.cam.y;
    const tx=Math.floor(mx/TILE), ty=Math.floor(my/TILE);
    const m=G.maps[G.map];
    if(tx<0||tx>=W||ty<0||ty>=H) return;
    
    // Range Check
    if(Math.hypot((tx*TILE)-G.p.x, (ty*TILE)-G.p.y) > 100) return;

    const t = m.d[ty][tx];
    const it = G.inv[G.slot];
    if(!it || G.stam<=0) return;

    let did=false;
    // Tools
    if(it.id=='hoe' && t.t=='grass' && !t.obj) { t.t='till'; did=true; }
    if(it.id=='water' && (t.t=='till'||t.crop)) { t.t='wet'; if(t.crop) t.crop.w=true; did=true; }
    if(it.id=='axe' && (t.obj=='wood'||t.obj=='tree')) { t.obj=null; t.sol=false; pop('+Wood',mx,my); did=true; }
    if(it.id=='pick' && t.obj=='stone') { t.obj=null; t.sol=false; pop('+Stone',mx,my); did=true; }
    if(it.id=='scythe' && t.crop && t.crop.s==3) { 
        t.crop=null; t.obj=null; G.money+=50; pop('+50 G',mx,my,'gold'); did=true; 
    }
    // Seeds
    if(it.type=='seed' && t.t=='till' && !t.crop) {
        t.crop={s:1, w:(t.t=='wet')}; it.ct--; 
        if(it.ct<=0) G.inv[G.slot]=null; 
        did=true;
    }

    if(did) { G.stam-=2; ui(); }
}

function sleep() {
    G.day++; G.hr=6; G.stam=G.maxStam;
    // Grow Crops
    const m = G.maps.farm.d;
    for(let row of m) for(let t of row) {
        if(t.t=='wet') t.t='till';
        if(t.crop && t.crop.w) { t.crop.w=false; if(t.crop.s<3) t.crop.s++; }
    }
    save(); pop("Slept!", G.p.x, G.p.y); ui();
}

function loop() {
    if(!G.pause) {
        // Time
        G.tick++;
        if(G.tick>60) { 
            G.tick=0; G.min+=10; 
            if(G.min==60){G.min=0; G.hr++; if(G.hr==24)G.hr=0;}
            // Night
            let o=0; if(G.hr>=19||G.hr<5)o=0.6; else if(G.hr>=17)o=0.3;
            document.getElementById('overlay').style.backgroundColor=`rgba(0,0,50,${o})`;
            ui();
        }

        // Move
        let vx=0, vy=0;
        if(keys['w'])vy=-G.p.spd; if(keys['s'])vy=G.p.spd;
        if(keys['a'])vx=-G.p.spd; if(keys['d'])vx=G.p.spd;
        
        // Map Transfer
        if(G.map=='farm' && G.p.y > H*TILE-20) { G.map='town'; G.p.y=20; }
        else if(G.map=='town' && G.p.y < 0) { G.map='farm'; G.p.y=H*TILE-40; }
        else {
            if(!col(G.p.x+vx, G.p.y)) G.p.x+=vx;
            if(!col(G.p.x, G.p.y+vy)) G.p.y+=vy;
        }

        // Camera
        G.cam.x = Math.max(0, Math.min(G.p.x - CVS_W/2, W*TILE - CVS_W));
        G.cam.y = Math.max(0, Math.min(G.p.y - CVS_H/2, H*TILE - CVS_H));
        
        // Floats
        for(let i=G.floats.length-1; i>=0; i--) {
            let f = G.floats[i]; f.y-=1; f.l--;
            if(f.l<=0) G.floats.splice(i,1);
        }
    }
    draw(); requestAnimationFrame(loop);
}

function col(x,y) {
    if(x<0||y<0||x>W*TILE||y>H*TILE) return true;
    return G.maps[G.map].d[Math.floor((y+30)/TILE)][Math.floor((x+20)/TILE)].sol;
}

// --- RENDER ---
function draw() {
    ctx.clearRect(0,0,CVS_W,CVS_H);
    const m = G.maps[G.map].d;
    const sx=Math.floor(G.cam.x/TILE), sy=Math.floor(G.cam.y/TILE);
    
    // Draw Map
    for(let y=sy; y<sy+17; y++) for(let x=sx; x<sx+22; x++) {
        if(y<0||y>=H||x<0||x>=W) continue;
        const t = m[y][x];
        const dx = x*TILE-G.cam.x, dy = y*TILE-G.cam.y;
        
        ctx.fillStyle = GFX[t.t]||'#000'; ctx.fillRect(dx,dy,TILE,TILE); // Ground
        ctx.strokeStyle='rgba(0,0,0,0.1)'; ctx.strokeRect(dx,dy,TILE,TILE);
        
        ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='28px serif';
        
        if(t.obj) ctx.fillText(GFX[t.obj]||'?', dx+20, dy+20); // Objects
        if(t.crop) {
            let s = GFX.s_turnip;
            if(t.crop.s==2) s=GFX.p_turnip;
            if(t.crop.s==3) s=GFX.r_turnip;
            ctx.fillText(s, dx+20, dy+20);
        }
    }

    // Draw Ents
    for(let e of G.ents) if(e.m==G.map) ctx.fillText(GFX[e.spr], e.x*TILE-G.cam.x+20, e.y*TILE-G.cam.y+20);
    
    // Draw Player
    ctx.fillText(GFX.p, G.p.x-G.cam.x+20, G.p.y-G.cam.y+20);

    // Selector
    const mx=mouse.x+G.cam.x, my=mouse.y+G.cam.y;
    const tx=Math.floor(mx/TILE), ty=Math.floor(my/TILE);
    ctx.strokeStyle='yellow'; ctx.lineWidth=2; ctx.strokeRect(tx*TILE-G.cam.x, ty*TILE-G.cam.y, TILE, TILE);

    // Floats
    ctx.font='bold 20px monospace';
    for(let f of G.floats) { ctx.fillStyle=f.c; ctx.fillText(f.t, f.x-G.cam.x, f.y-G.cam.y); }
}

// --- UI & DATA ---
function ui() {
    document.getElementById('date').innerText = `Day ${G.day} ${G.hr.toString().padStart(2,'0')}:${G.min.toString().padStart(2,'0')}`;
    document.getElementById('cash').innerText = G.money + ' G';
    document.getElementById('nrg').innerText = G.stam + '/' + G.maxStam;
    const b = document.getElementById('bar'); b.innerHTML='';
    G.inv.forEach((i,idx)=>{
        let d=document.createElement('div'); d.className='slot '+(idx==G.slot?'on':'');
        if(i){ d.innerHTML=i.s; if(i.ct) d.innerHTML+=`<span class="ct">${i.ct}</span>`; }
        d.onclick=()=>{G.slot=idx; ui();}; b.appendChild(d);
    });
}
function msg(n,t) { G.pause=true; document.getElementById('dlg').style.display='block'; document.getElementById('dName').innerText=n; document.getElementById('dMsg').innerText=t; }
function pop(t,x,y,c='white') { G.floats.push({t,x,y,l:60,c}); }

function shop(open) {
    const s=document.getElementById('shop');
    if(!open) { s.style.display='none'; G.pause=false; return; }
    G.pause=true; s.style.display='block';
    const l=document.getElementById('list'); l.innerHTML='';
    [{n:'Turnip',p:20},{n:'Potato',p:30}].forEach(seed=>{
        let d=document.createElement('div'); d.className='buy';
        d.innerHTML=`<span>${seed.n}</span><span>${seed.p}G</span>`;
        d.onclick=()=>{
            if(G.money>=seed.p){
                G.money-=seed.p; 
                let f=G.inv.find(x=>x&&x.id=='turnip'); if(f) f.ct+=5; 
                else { for(let i=0;i<10;i++) if(!G.inv[i]){G.inv[i]={id:'turnip',s:'ğŸŒ±',ct:5,type:'seed',val:seed.p}; break;} }
                ui();
            }
        };
        l.appendChild(d);
    });
}

function save() { localStorage.setItem('osv_save', JSON.stringify({d:G.day, m:G.money, i:G.inv})); }
function load() { const d=JSON.parse(localStorage.getItem('osv_save')); if(d){G.day=d.d; G.money=d.m; G.inv=d.i;} }

init();
</script>
</body>
</html>